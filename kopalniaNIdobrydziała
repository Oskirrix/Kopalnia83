// ==UserScript==
// @name         Margonem Kopalnia NI
// @namespace    http://tampermonkey.net/
// @version      6.0
// @description  Flaga UA w panelu "Kto jest tutaj" + logger heroików, legend i unikatów na Discord (Nowy Interfejs, poprawne porównanie nicków)
// @author       Kuchar
// @match        https://*.margonem.pl/*
// @exclude      https://margonem.pl/
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // --- KONFIG ---
    const SERVER_URL = 'https://kopalnia83.onrender.com';
    const UKRAINE_FLAG_URL = 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Flag_of_Ukraine.svg/24px-Flag_of_Ukraine.svg.png';
    const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1374483070010265631/8NcxnxFprvWY7f0XHV2ID6fxC15dNv-ssJMJLDZRy7_jBEjBfpXh2R4wcRqfC-LTJIVO';
    const REGISTER_INTERVAL = 10 * 1000;
    const ACTIVE_CHECK_INTERVAL = 10 * 1000;
    const FLAG_UPDATE_INTERVAL = 500;

    let lastActiveNicks = [];

    // --- NICK NORMALIZATOR ---
    function normalizeNick(nick) {
        // Usuwa lvl w nawiasie (np. "Sigma Kamilek (83w)") lub na końcu (np. "Sigma Kamilek 83w")
        return nick.replace(/\s*\(.*?\)$/, '').replace(/\s+\d+\w?$/, '').trim().toLowerCase();
    }

    // --- REJESTRACJA NA BACKENDZIE ---
    function getPlayerName() {
        let nickElem = document.querySelector('.heroname');
        return nickElem ? nickElem.textContent.trim() : null;
    }

    function registerAddon() {
        const nick = getPlayerName();
        if (!nick) return;
        fetch(`${SERVER_URL}/register`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({nick})
        }).catch(e => console.error('[KopalniaAddon] Błąd rejestracji:', e));
    }

    async function updateActiveNicks() {
        try {
            const response = await fetch(`${SERVER_URL}/active`);
            if (!response.ok) throw new Error('Błąd pobierania listy aktywnych');
            lastActiveNicks = await response.json();
        } catch (e) {
            console.error('[KopalniaAddon] Błąd aktywnych:', e);
        }
    }

    // --- FLAGI UA W PANELU "KTO JEST TUTAJ" + GARGONEM ---
    function drawFlagsInWhoIsHere() {
        // Usuwanie starych flag
        document.querySelectorAll('.addon-flag-ua').forEach(e => e.remove());

        // Panel "Kto jest tutaj"
        document.querySelectorAll('.one-other.tw-list-item .name .inner').forEach(el => {
            const nick = el.textContent.trim();
            let hasAddon = false;
            for (const activeNick of lastActiveNicks) {
                if (normalizeNick(activeNick) === normalizeNick(nick)) {
                    hasAddon = true;
                    break;
                }
            }
            if (!hasAddon) {
                const flag = document.createElement('img');
                flag.src = UKRAINE_FLAG_URL;
                flag.className = 'addon-flag-ua';
                flag.style.cssText = `
                    width: 16px;
                    height: 11px;
                    margin-left: 4px;
                    vertical-align: middle;
                `;
                el.appendChild(flag);
            }
        });

        // Panel Gargonem
        document.querySelectorAll('.gargonem-otherlist-left.nowrap.ellipsis').forEach(el => {
            const nick = el.textContent.trim();
            let hasAddon = false;
            for (const activeNick of lastActiveNicks) {
                if (normalizeNick(activeNick) === normalizeNick(nick)) {
                    hasAddon = true;
                    break;
                }
            }
            if (!hasAddon) {
                const flag = document.createElement('img');
                flag.src = UKRAINE_FLAG_URL;
                flag.className = 'addon-flag-ua';
                flag.style.cssText = `
                    width: 16px;
                    height: 11px;
                    margin-left: 4px;
                    vertical-align: middle;
                `;
                el.appendChild(flag);
            }
        });
    }

    // --- LOGGER LOOTÓW NA DISCORD (obsługuje WSZYSTKIE miejsca lootu) ---
    function setupLootObserver() {
        function tryInit() {
            // Obserwuj całą grę, bo looty mogą pojawiać się w różnych miejscach
            const root = document.body;
            if (!root) {
                setTimeout(tryInit, 1000);
                return;
            }
            const sentLootIds = new Set();

            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (!(node instanceof HTMLElement)) return;
                        // Szukaj lootów w każdym nowym elemencie
                        const lootItems = node.matches('.item[data-frame-mania-rarity]')
                            ? [node]
                            : node.querySelectorAll('.item[data-frame-mania-rarity]');
                        lootItems.forEach(itemDiv => {
                            const lootId = itemDiv.className.match(/item-id-(\d+)/)?.[1];
                            if (!lootId) return;
                            if (sentLootIds.has(lootId)) return;
                            sentLootIds.add(lootId);

                            const name = itemDiv.dataset.name || 'Nieznany przedmiot';
                            const rarity = itemDiv.dataset.frameManiaRarity || 'zwykły';
                            const amount = itemDiv.querySelector('.amount')?.textContent || '1';
                            if (!['heroic', 'legendary', 'unique'].includes(rarity)) return;

                            const playerName = getPlayerName() || 'Nieznany gracz';
                            const time = new Date().toLocaleTimeString();
                            const message = `[${time}] ${playerName} zdobył: **${name}** (${rarity}) x${amount}`;
                            sendToDiscord(message);
                            console.log('Wysłano na Discorda:', message);
                        });
                    });
                });
            });

            observer.observe(root, {childList: true, subtree: true});
        }
        tryInit();
    }

    function sendToDiscord(message) {
        fetch(DISCORD_WEBHOOK_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: message})
        })
        .then(r => r.ok ? null : r.text().then(console.error))
        .catch(e => console.error('Błąd wysyłania do Discord:', e));
    }

    // --- START ---
    console.log('[KopalniaAddon] Skrypt Margonem NI (flaga UA + logger lootów wszędzie) startuje');

    registerAddon();
    updateActiveNicks();

    setInterval(registerAddon, REGISTER_INTERVAL);
    setInterval(updateActiveNicks, ACTIVE_CHECK_INTERVAL);
    setInterval(drawFlagsInWhoIsHere, FLAG_UPDATE_INTERVAL);

    setupLootObserver();

})();
