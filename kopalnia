// ==UserScript==
// @name         Kopalnia 83
// @namespace    http://tampermonkey.net/
// @version      1.1
// @description  Oznacza graczy bez dodatku flagą Ukrainy
// @author       Kuchar
// @match        https://*.margonem.pl/*
// @updateURL    https://raw.githubusercontent.com/Oskirrix/Kopalnia83/refs/heads/main/kopalnia
// @downloadURL  https://raw.githubusercontent.com/Oskirrix/Kopalnia83/refs/heads/main/kopalnia
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1372189904410247238/DLNgurQp6epT8Ud7oMfE4ZUxh9pAE3BtQtJVlD1ccizb3c21Dv1PvvoWp0EpyLG4CNMB';

    function sendToDiscord(message) {
        fetch(DISCORD_WEBHOOK_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: message})
        }).catch(e => console.error('Błąd wysyłania do Discord:', e));
    }

    function getPlayerName() {
        let nickElem = document.querySelector('.user-nick, .nick, #nick');
        return nickElem ? nickElem.textContent.trim() : 'Nieznany gracz';
    }

    function parseItemTip(tip) {
        if (!tip) return null;

        const decoded = tip.replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>');

        const nameMatch = decoded.match(/<b class="item-name">([^<]+)<\/b>/);
        const name = nameMatch ? nameMatch[1] : 'Nieznany przedmiot';

        // Poprawne rozpoznawanie rzadkości po polsku i angielsku
        const isUnique = /class="unique".*unikat/i.test(decoded);
        const isHeroic = /class="heroic".*heroi/i.test(decoded);
        const isLegendary = /class="legendary".*legen/i.test(decoded);

        const typeMatch = decoded.match(/<span class="type-text">Typ:\s*([^<]+)<\/span>/);
        const type = typeMatch ? typeMatch[1].trim() : '';

        const amountMatch = decoded.match(/<span class="amount-text">Ilość:\s*(\d+)\s*<\/span>/);
        const amount = amountMatch ? amountMatch[1] : '1';

        let rarity = 'Zwykły';
        if (isLegendary) rarity = 'Legendarny';
        else if (isHeroic) rarity = 'Heroiczny';
        else if (isUnique) rarity = 'Unikatowy';

        return {
            name,
            rarity,
            type,
            amount
        };
    }

    const lootsContainer = document.getElementById('loots');
    if (!lootsContainer) {
        console.warn('Nie znaleziono elementu #loots');
        return;
    }

    const sentLootIds = new Set();

    const observer = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
            mutation.addedNodes.forEach(node => {
                if (!(node instanceof HTMLElement)) return;

                const lootWrappers = node.matches('.loot-wrapper') ? [node] : node.querySelectorAll('.loot-wrapper');
                lootWrappers.forEach(lootWrapper => {
                    const lootId = lootWrapper.id || lootWrapper.querySelector('.item')?.id || null;
                    if (!lootId) return;

                    if (sentLootIds.has(lootId)) return;
                    sentLootIds.add(lootId);

                    const itemDiv = lootWrapper.querySelector('.item');
                    if (!itemDiv) return;

                    const itemInfo = parseItemTip(itemDiv.getAttribute('tip') || itemDiv.getAttribute('ctip'));
                    if (!itemInfo) return;

                    // Pomijaj tylko zwykłe looty (common)
                    if (itemInfo.rarity === 'Zwykły') return;

                    const playerName = getPlayerName();
                    const time = new Date().toLocaleTimeString();

                    const message = `[${time}] ${playerName} zdobył: **${itemInfo.name}** (${itemInfo.rarity}) x${itemInfo.amount} - Typ: ${itemInfo.type}`;

                    sendToDiscord(message);
                    console.log('Wysłano loot:', message);
                });
            });
        });
    });

    observer.observe(lootsContainer, {childList: true, subtree: true});

    console.log('Logger lootów Margonem uruchomiony - nasłuchuję nowych lootów w #loots');
})();
